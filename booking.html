<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Barber Admin Panel</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<style>
  /* ==================== Global Styles ==================== */
  *{margin:0;padding:0;box-sizing:border-box}
  html,body{height:100%;overflow-x:hidden;background:#0a0a0a;color:#fff;font-family:'Segoe UI',sans-serif}
  body{background:url('salon.jpg') center/cover fixed;position:relative}

  /* ADDED: Global Tap/Focus Removal for Mobile devices */
  *{
    -webkit-tap-highlight-color: transparent; /* Removes tap highlight on WebKit/Android */
  }
  
  /* ==================== Header ==================== */
  .header{
    text-align:center;margin:20px auto 30px;padding:22px;
    background:rgba(255,255,255,.15);border-radius:20px;
    backdrop-filter:blur(14px);border:1px solid rgba(255,255,255,.35);
    box-shadow:0 10px 35px rgba(0,0,0,.4);max-width:600px
  }
  .header h1{
    font-size:clamp(2rem,7vw,2.8rem);font-weight:800;
    background:linear-gradient(90deg,#ffd700,#fffbe6,#ffd700);
    -webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;
    letter-spacing:2.5px;text-shadow:0 0 18px rgba(255,215,0,.6)
  }
  .header p{color:#ccc;font-size:1.1rem;margin-top:10px}

  /* ==================== Bookings Cards ==================== */
  .bookings-container{
    display:flex;flex-direction:column;gap:18px;
    max-width:460px;margin:0 auto;padding:0 15px;
    align-items:center;
    margin-bottom: 120px; 
  }
  .booking-card{
    background:rgba(255,255,255,.18);border:1.5px solid rgba(255,255,255,.45);
    border-radius:18px;padding:20px;backdrop-filter:blur(16px);
    box-shadow:0 10px 32px rgba(0,0,0,.4);position:relative;overflow:hidden;
    transition:transform .3s,box-shadow .3s;width:100%
  }
  .booking-card::before{
    content:'';position:absolute;top:0;left:-120%;width:60%;height:100%;
    background:linear-gradient(90deg,transparent,rgba(255,255,255,.35),transparent);
    transform:skewX(-25deg);transition:left .8s
  }
  .booking-card:hover::before{left:150%}
  .booking-card:hover{transform:translateY(-6px);box-shadow:0 16px 40px rgba(0,0,0,.5)}

  .detail{
    display:flex;justify-content:space-between;margin-bottom:10px;
    font-size:1.05rem;align-items:center
  }
  .detail strong{color:#ffd700;font-weight:600}
  
  .time-card{
    text-align:center;margin:16px 0 10px;padding:12px;
    background:rgba(255,215,0,.22);border:2px dashed #ffd700;
    border-radius:14px;font-size:1.4rem;font-weight:800;
    color:#fffbe6;text-shadow:0 1px 3px rgba(0,0,0,.6);
  }

  .cancel-btn{
    background:linear-gradient(45deg,#ff4444,#cc0000);color:#fff;
    border:none;padding:10px 16px;border-radius:10px;font-weight:600;
    cursor:pointer;margin-top:12px;width:100%;font-size:0.95rem;
    transition:transform .2s
  }
  /* ADDED: Remove focus outline on buttons */
  .cancel-btn:focus{
    outline: none;
    box-shadow: none;
  }
  .cancel-btn:hover{transform:scale(1.03)}

  .no-bookings{
    text-align:center;padding:60px 20px;color:#aaa;font-size:1.4rem;
    display:none;margin-top:40px
  }
  .no-bookings img{width:100px;opacity:.7;margin-bottom:20px;filter:drop-shadow(0 3px 6px rgba(0,0,0,.4))}

  /* ==================== Floating Button ==================== */
  .refresh-btn{
    position:fixed;bottom:30px;left:50%;transform:translateX(-50%);
    width:65px;height:65px;background:rgba(0,209,255,.15);
    border:2px solid #00d1ff;border-radius:50%;cursor:pointer;
    display:flex;align-items:center;justify-content:center;z-index:1000;
    box-shadow:0 6px 20px rgba(0,209,255,.4);transition:all .3s
  }
  /* ADDED: Remove focus outline on refresh button */
  .refresh-btn:focus{
    outline: none;
    box-shadow: 0 6px 20px rgba(0,209,255,.4); /* Keep box shadow on focus */
  }
  .refresh-btn:hover{background:rgba(0,209,255,.25);transform:translateX(-50%) scale(1.1)}
  .refresh-btn:active{animation:pulse .5s}
  .refresh-btn svg{width:40px;height:40px;fill:#00d1ff;filter:drop-shadow(0 2px 5px rgba(0,0,0,.5))}
  @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(0,209,255,.7)}100%{box-shadow:0 0 0 20px rgba(0,209,255,0)}}

  /* ==================== Confirmation Modal ==================== */
  .modal{
    position:fixed;inset:0;background:rgba(0,0,0,0.85);backdrop-filter:blur(12px);
    display:none;align-items:center;justify-content:center;z-index:2000;
    padding:20px;opacity:0;transition:opacity .3s
  }
  .modal.show{display:flex;opacity:1}
  .modal-card{
    background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.3);
    border-radius:18px;padding:24px;max-width:360px;width:100%;
    box-shadow:0 15px 40px rgba(0,0,0,.5);text-align:center;color:#fff
  }
  .modal-card h3{
    margin-bottom:18px;font-size:1.4rem;color:#ffd700
  }
  .modal-info{
    background:rgba(255,255,255,.08);border-radius:12px;padding:14px;
    margin-bottom:20px;text-align:left;
    font-size:1rem;line-height:1.8
  }
  .modal-info strong{color:#ffd700}
  .modal-buttons{
    display:flex;gap:12px
  }
  .modal-btn{
    flex:1;padding:12px;border-radius:12px;font-weight:600;cursor:pointer;
    transition:transform .2s;border:none;
  }
  /* ADDED: Remove focus outline on modal buttons */
  .modal-btn:focus{
    outline: none;
    box-shadow: none;
  }
  /* Yes button: Black background, Red text */
  .modal-btn.yes{
    background:#000;
    color:#ff0000;
    border:1px solid #ff0000;
  }
  /* No button: Aqua background, Black text */
  .modal-btn.no{
    background:#00FFFF;
    color:#000;
    border:1px solid #000;
  }
  .modal-btn:hover{transform:scale(1.05)}

  @media(max-width:480px){
    .bookings-container{max-width:100%;padding:0 10px}
    .modal-card{padding:20px}
    .modal-info{font-size:0.95rem}
  }
</style>
</head>
<body>

<div class="header">
  <h1>Barber Admin Panel</h1>
  <p>All new bookings appear instantly</p>
</div>

<div id="c" class="bookings-container"></div>
<div id="n" class="no-bookings">
  <img src="https://cdn-icons-png.flaticon.com/512/7484/7484788.png" alt="No bookings">
  <p>No active bookings yet</p>
</div>

<button class="refresh-btn" id="r" title="Refresh" aria-label="Refresh">
  <svg viewBox="0 0 24 24"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
</button>

<div class="modal" id="confirmModal">
  <div class="modal-card">
    <h3>Cancel Appointment?</h3>
    <div class="modal-info" id="modalInfo"></div>
    <div class="modal-buttons">
      <button class="modal-btn yes" id="confirmYes">Yes</button>
      <button class="modal-btn no" id="confirmNo">No</button>
    </div>
  </div>
</div>

<script>
// ==================== Firebase Config ====================
// IMPORTANT: Update these values with your actual project information
const firebaseConfig = {
  apiKey: "AIzaSyDd2uTkqOcwgDIRHVpRhThB-NtXW7x5qGk",
  authDomain: "pixup-4e257.firebaseapp.com",
  databaseURL: "https://pixup-4e257-default-rtdb.firebaseio.com",
  projectId: "pixup-4e257",
  storageBucket: "pixup-4e257.firebasestorage.app",
  messagingSenderId: "941738425715",
  appId: "1:941738425715:web:d5a513a1b6cbb4b4611906",
  measurementId: "G-VZHXB6XHDB"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const bookingsRef = db.ref('bookings'); 

const container = document.getElementById('c');
const noBookings = document.getElementById('n');
const refreshBtn = document.getElementById('r');
const modal = document.getElementById('confirmModal');
const modalInfo = document.getElementById('modalInfo');
const confirmYes = document.getElementById('confirmYes');
const confirmNo = document.getElementById('confirmNo');

let pendingCancel = null;

// Service Translation Map (for display)
const servicesMap = {
  haircut: 'Haircut',
  beard: 'Beard Trim',
  haircolor: 'Hair Coloring',
  facial: 'Facial Treatment',
  combo: 'Combo Package'
};

/**
 * Function to fetch, sort, and render bookings
 */
function renderBookings(snapshot) {
  container.innerHTML = '';
  const bookings = [];

  // Iterate over the structure bookings/{date}/{time}/{bookingKey}
  snapshot.forEach(dateSnap => {
    const date = dateSnap.key;
    dateSnap.forEach(timeSnap => {
      const time = timeSnap.key;
      timeSnap.forEach(bookingSnap => {
        const data = bookingSnap.val();
        // Only display non-cancelled bookings
        if (data && !data.cancelled) {
          bookings.push({
            id: `${date}_${time}_${bookingSnap.key}`, 
            dateKey: date,
            timeKey: time,
            bookingKey: bookingSnap.key,
            ...data
          });
        }
      });
    });
  });

  // Sort bookings descendingly (newest/soonest first)
  bookings.sort((a, b) => {
    const dateTimeA = `${a.dateKey} ${a.timeKey}`;
    const dateTimeB = `${b.dateKey} ${b.timeKey}`;
    
    // Create Date objects for proper comparison
    const dateA = new Date(dateTimeA.replace(/-/g, '/')); 
    const dateB = new Date(dateTimeB.replace(/-/g, '/'));

    return dateB.getTime() - dateA.getTime(); 
  });

  // Show/Hide No Bookings message
  if (bookings.length === 0) {
    noBookings.style.display = 'block';
    return;
  }
  noBookings.style.display = 'none';

  // Create and display booking cards
  bookings.forEach(b => {
    const card = document.createElement('div');
    card.className = 'booking-card';

    const serviceName = servicesMap[b.service] || b.service;

    card.innerHTML = `
      <div class="detail"><strong>Name:</strong> <span>${b.name || '—'}</span></div>
      <div class="detail"><strong>Phone:</strong> <span dir="ltr">${b.phone || '—'}</span></div>
      <div class="detail"><strong>Date:</strong> <span>${b.dateLabel || '—'}</span></div>
      <div class="detail"><strong>Service:</strong> <span>${serviceName}</span></div>
      <div class="time-card">${b.timeLabel || '—'}</div>
      <button class="cancel-btn" 
              data-date="${b.dateKey}" 
              data-time="${b.timeKey}" 
              data-key="${b.bookingKey}">
        Cancel Appointment
      </button>
    `;

    container.appendChild(card);
  });

  // Add click event for Cancel buttons
  document.querySelectorAll('.cancel-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const date = btn.dataset.date;
      const time = btn.dataset.time;
      const key = btn.dataset.key;

      const booking = bookings.find(b => 
        b.dateKey === date && b.timeKey === time && b.bookingKey === key
      );

      pendingCancel = { date, time, key, booking };
      showConfirmModal(booking);
    });
  });
}

/**
 * Show confirmation modal
 */
function showConfirmModal(booking) {
  const service = servicesMap[booking.service] || booking.service;
  // Display booking information in the modal
  modalInfo.innerHTML = `
    <div><strong>Name:</strong> ${booking.name || '—'}</div>
    <div><strong>Phone:</strong> ${booking.phone || '—'}</div>
    <div><strong>Date:</strong> ${booking.dateLabel || '—'}</div>
    <div><strong>Time:</strong> ${booking.timeLabel || '—'}</div>
    <div><strong>Service:</strong> ${service}</div>
  `;
  modal.classList.add('show');
}

/**
 * Close confirmation modal
 */
function closeModal() {
  modal.classList.remove('show');
  pendingCancel = null;
}

// Event handlers for modal buttons
confirmYes.onclick = () => {
  if (!pendingCancel) return;

  const { date, time, key } = pendingCancel;

  // Update booking status in Firebase to cancelled: true
  bookingsRef.child(date).child(time).child(key).update({ cancelled: true })
    .then(() => {
      closeModal();
      pendingCancel = null;
    })
    .catch(() => alert('Error canceling appointment'));
};

confirmNo.onclick = closeModal;
modal.addEventListener('click', e => { if (e.target === modal) closeModal(); });

// ==================== Real-time Listener ====================
// Listens for real-time updates and re-renders the list
bookingsRef.on('value', renderBookings, (error) => {
  console.error(error);
  noBookings.style.display = 'block';
  noBookings.querySelector('p').textContent = 'Connection failed. Please check your network.';
});

// ==================== Refresh Button Functionality ====================
refreshBtn.onclick = () => {
  noBookings.style.display = 'none';
  // Manually fetch data once
  bookingsRef.once('value').then(renderBookings).catch(() => {
    noBookings.style.display = 'block';
    noBookings.querySelector('p').textContent = 'Refresh failed';
  });
};
</script>
</body>
</html>
